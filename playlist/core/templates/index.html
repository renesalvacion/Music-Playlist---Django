<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Music SoundTrip - MTV Mode</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center">

<header class="text-center py-6">
  <h1 class="text-4xl font-bold text-pink-500">ğŸµ Music SoundTrip - MTV</h1>
  <p class="text-gray-300 mt-2">Auto-play your favorite tracks!</p>
</header>

<div class="w-full max-w-4xl mb-6">
  <div id="video-player"></div>
</div>

<form id="add-music-form" class="mb-6 w-full max-w-4xl flex">
  <input type="text" name="title" placeholder="Song Name - Artist"
         class="flex-1 p-3 rounded-l-lg text-black" required>
  <button class="bg-pink-500 p-3 rounded-r-lg font-bold">Add Track</button>
</form>

<section id="playlist" class="w-full max-w-4xl grid gap-4">
  {% for track in playlist %}
  <div class="bg-gray-800 p-3 rounded-lg flex items-center hover:bg-gray-700 cursor-pointer"
       onclick="playVideo('{{ track.youtube_video_id }}', {{ forloop.counter0 }})">

    <img src="{{ track.thumbnail }}" class="w-24 h-24 rounded-lg mr-4">

    <div class="flex-1">
      <h2 class="text-xl font-semibold">{{ track.song_name }}</h2>
      <p class="text-gray-400">{{ track.artist }}</p>
    </div>

    <span class="mr-3 text-pink-500">â–¶ï¸</span>

    <button onclick="deleteTrack(event, '{{ track.youtube_video_id }}')"
            class="text-red-500 text-xl">ğŸ—‘ï¸</button>
  </div>
  {% endfor %}
</section>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
let player;
let currentIndex = 0;

const playlistIds = [
  {% for track in playlist %}
    "{{ track.youtube_video_id }}"{% if not forloop.last %},{% endif %}
  {% endfor %}
];

function onYouTubeIframeAPIReady() {
  player = new YT.Player('video-player', {
    height: '400',
    width: '100%',
    videoId: playlistIds[0] || '',
    events: { onStateChange }
  });
}

function onStateChange(e) {
  if (e.data === YT.PlayerState.ENDED) {
    currentIndex = (currentIndex + 1) % playlistIds.length;
    player.loadVideoById(playlistIds[currentIndex]);
  }
}

function playVideo(id, index) {
  currentIndex = index;
  player.loadVideoById(id);
}

function addTrackToDOM(track, index) {
  const div = document.createElement("div");
  div.className = "bg-gray-800 p-3 rounded-lg flex items-center hover:bg-gray-700 cursor-pointer";
  div.onclick = () => playVideo(track.youtube_video_id, index);

  div.innerHTML = `
    <img src="${track.thumbnail}" class="w-24 h-24 rounded-lg mr-4">
    <div class="flex-1">
      <h2 class="text-xl font-semibold">${track.song_name}</h2>
      <p class="text-gray-400">${track.artist}</p>
    </div>
    <span class="mr-3 text-pink-500">â–¶ï¸</span>
    <button class="text-red-500 text-xl">ğŸ—‘ï¸</button>
  `;

  div.querySelector("button").onclick = (e) => deleteTrack(e, track.youtube_video_id);
  document.getElementById("playlist").appendChild(div);
}

document.getElementById("add-music-form").addEventListener("submit", async e => {
  e.preventDefault();

  const res = await fetch("{% url 'add_music' %}", {
    method: "POST",
    body: new FormData(e.target),
    headers: { "X-CSRFToken": "{{ csrf_token }}" }
  });

  const data = await res.json();
  if (data.error) return alert(data.error);

  playlistIds.push(data.track.youtube_video_id);
  addTrackToDOM(data.track, playlistIds.length - 1);
  playVideo(data.track.youtube_video_id, playlistIds.length - 1);

  e.target.reset();
});

async function deleteTrack(e, videoId) {
  e.stopPropagation();

  await fetch("{% url 'delete_music' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ youtube_video_id: videoId })
  });

  location.reload();
}
</script>

</body>
</html>
